<div class="min-h-screen bg-gradient-to-br from-emerald-50 via-white to-emerald-50 py-4 px-2 sm:px-4 lg:px-8">
    <div class="max-w-full mx-auto">
        <div class="bg-emerald-500 rounded-t-2xl shadow-lg p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 sm:w-10 sm:h-10 text-white" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    <div>
                        <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-white">Editar Venta</h1>
                        <p class="text-emerald-100 text-xs sm:text-sm mt-1">Modifica los datos de la venta seleccionada
                        </p>
                    </div>
                </div>
                <button [routerLink]="['/ventas/lista']"
                    class="flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white font-semibold px-4 py-2 rounded-lg shadow-md transition-all text-sm sm:text-base w-full sm:w-auto justify-center">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Volver al Listado
                </button>
            </div>
        </div>

        <div class="bg-white rounded-b-2xl shadow-xl p-4 sm:p-6 lg:p-8">
            @if (cargando()) {
            <div class="text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto"></div>
                <p class="text-gray-600 mt-4">Cargando venta...</p>
            </div>
            }

            @if (error() && !cargando()) {
            <div class="text-center py-12 text-gray-500">
                <svg class="w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-lg">{{ error() }}</p>
                <button (click)="obtenerVenta()"
                    class="mt-4 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors">
                    Reintentar
                </button>
            </div>
            }

            @if (getVentaData() && !cargando()) {
            <div class="mb-8">
                <h2
                    class="text-lg sm:text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2 border-b-2 border-gray-200 pb-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Información de la Venta (No editable)
                </h2>
                <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-4 sm:p-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Creación</label>
                            <input type="text" [value]="formatDate(getVentaData()?.createdAt)" readonly
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-600 text-sm sm:text-base" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ID de la Venta</label>
                            <input type="text" [value]="getVentaData()?.id || 'N/A'" readonly
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-600 text-sm sm:text-base" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">UUID</label>
                            <input type="text" [value]="getVentaData()?.uuid || 'N/A'" readonly
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-600 text-sm sm:text-base" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Asesor</label>
                            <input type="text" [value]="getVentaData()?.asesor?.fullName || 'N/A'" readonly
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-600 text-sm sm:text-base" />
                        </div>
                    </div>

                    @if (tienePlanPago()) {
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-md font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                            </svg>
                            Plan de Pago (No editable)
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total del Plan</label>
                                <input type="text" [value]="'$ ' + (getPlanPago()?.total | number:'1.2-2')" readonly
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-600 text-sm sm:text-base" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Monto Inicial</label>
                                <input type="text" [value]="'$ ' + (getPlanPago()?.monto_inicial | number:'1.2-2')"
                                    readonly
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-600 text-sm sm:text-base" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Estado del Plan</label>
                                <input type="text" [value]="getPlanPago()?.estado" readonly
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-600 text-sm sm:text-base" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha Vencimiento</label>
                                <input type="text" [value]="formatDate(getPlanPago()?.fecha_vencimiento)" readonly
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-600 text-sm sm:text-base" />
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p class="text-xs text-gray-500">Total Pagado</p>
                                <p class="text-lg font-bold text-green-600">$ {{ getTotalPagado() | number:'1.2-2' }}
                                </p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-500">Saldo Pendiente</p>
                                <p class="text-lg font-bold text-orange-600">$ {{ getSaldoPendiente() | number:'1.2-2'
                                    }}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-500">Porcentaje Pagado</p>
                                <p class="text-lg font-bold text-blue-600">{{ getPorcentajePagado() | number:'1.0-0' }}%
                                </p>
                            </div>
                        </div>
                    </div>
                    }
                </div>
            </div>

            <form [formGroup]="ventaForm" (submit)="handleFormSubmit($event)">
                <div class="mb-8">
                    <h2
                        class="text-lg sm:text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2 border-b-2 border-gray-200 pb-2">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Editar Información de la Venta
                    </h2>
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-4 sm:p-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                            <!-- Cliente con buscador -->
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Cliente <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <input type="text" [value]="searchCliente()"
                                        (input)="searchCliente.set($any($event.target).value)"
                                        (focus)="toggleClientesDropdown()" (blur)="onClienteBlur()"
                                        placeholder="Buscar cliente..."
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all duration-200 text-sm sm:text-base pr-10"
                                        [class.border-red-500]="ventaForm.get('clienteId')?.invalid && ventaForm.get('clienteId')?.touched" />
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </div>
                                </div>

                                <!-- Dropdown de clientes -->
                                @if (showClientesDropdown()) {
                                <div
                                    class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                    @for (cliente of filteredClientes(); track cliente.id) {
                                    <div (click)="selectCliente(cliente)"
                                        class="px-4 py-3 hover:bg-emerald-50 cursor-pointer border-b border-gray-100 last:border-b-0">
                                        <div class="font-medium text-gray-900">{{ cliente.fullName }}</div>
                                        @if (cliente.ci) {
                                        <div class="text-sm text-gray-600">{{ cliente.ci }}</div>
                                        }
                                    </div>
                                    }
                                    @if (filteredClientes().length === 0) {
                                    <div class="px-4 py-3 text-gray-500 text-center">
                                        No se encontraron clientes
                                    </div>
                                    }
                                </div>
                                }

                                @if (ventaForm.get('clienteId')?.invalid && ventaForm.get('clienteId')?.touched) {
                                <p class="mt-1 text-xs text-red-600">El cliente es requerido</p>
                                }
                            </div>

                            <!-- Lote con buscador -->
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Lote <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <input type="text" [value]="searchLote()"
                                        (input)="searchLote.set($any($event.target).value)"
                                        (focus)="toggleLotesDropdown()" (blur)="onLoteBlur()"
                                        placeholder="Buscar lote..."
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all duration-200 text-sm sm:text-base pr-10"
                                        [class.border-red-500]="ventaForm.get('inmuebleId')?.invalid && ventaForm.get('inmuebleId')?.touched" />
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </div>
                                </div>

                                <!-- Dropdown de lotes -->
                                @if (showLotesDropdown()) {
                                <div
                                    class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                    @for (lote of filteredLotes(); track lote.id) {
                                    <div (click)="selectLote(lote)"
                                        class="px-4 py-3 hover:bg-emerald-50 cursor-pointer border-b border-gray-100 last:border-b-0">
                                        <div class="font-medium text-gray-900">{{ lote.numeroLote }} - {{
                                            lote.urbanizacion?.nombre }}</div>
                                        <div class="text-sm text-gray-600">${{ formatPrecio(lote.precioBase) }} - {{
                                            lote.estado }}</div>
                                    </div>
                                    }
                                    @if (filteredLotes().length === 0) {
                                    <div class="px-4 py-3 text-gray-500 text-center">
                                        No se encontraron lotes
                                    </div>
                                    }
                                </div>
                                }

                                @if (ventaForm.get('inmuebleId')?.invalid && ventaForm.get('inmuebleId')?.touched) {
                                <p class="mt-1 text-xs text-red-600">El lote es requerido</p>
                                }
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Precio Final ($) <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <span
                                        class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">$</span>
                                    <input type="number" step="0.01" formControlName="precioFinal"
                                        class="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all duration-200 text-sm sm:text-base"
                                        placeholder="0.00"
                                        [class.border-red-500]="ventaForm.get('precioFinal')?.invalid && ventaForm.get('precioFinal')?.touched" />
                                </div>
                                @if (ventaForm.get('precioFinal')?.invalid && ventaForm.get('precioFinal')?.touched) {
                                <p class="mt-1 text-xs text-red-600">El precio final es requerido</p>
                                }
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Estado
                                </label>
                                <select formControlName="estado"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all duration-200 text-sm sm:text-base">
                                    <option value="PENDIENTE_PAGO">Pendiente de Pago</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="border-2 border-gray-300 rounded-xl p-4 sm:p-6 mb-6 bg-blue-50">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        Resumen de los Cambios
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white rounded-lg p-4 shadow">
                            <p class="text-xs sm:text-sm text-gray-600 mb-1">Cliente</p>
                            <p class="text-lg sm:text-xl font-bold text-blue-700">
                                {{ getClienteNombre() }}
                            </p>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow">
                            <p class="text-xs sm:text-sm text-gray-600 mb-1">Precio Final</p>
                            <p class="text-lg sm:text-xl font-bold text-gray-700">
                                $ {{ (ventaForm.get('precioFinal')?.value || 0) | number:'1.2-2' }}
                            </p>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow">
                            <p class="text-xs sm:text-sm text-gray-600 mb-1">Estado</p>
                            <p class="text-lg sm:text-xl font-bold text-gray-700">
                                {{ ventaForm.get('estado')?.value || 'PENDIENTE_PAGO' }}
                            </p>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow">
                            <p class="text-xs sm:text-sm text-gray-600 mb-1">Lote</p>
                            <p class="text-lg sm:text-xl font-bold text-green-700">
                                {{ getLoteNombre() }}
                            </p>
                        </div>
                    </div>

                    @if (tienePlanPago()) {
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                            </svg>
                            <div>
                                <p class="text-sm font-medium text-yellow-800">Nota importante</p>
                                <p class="text-sm text-yellow-700">
                                    Esta venta tiene un plan de pago asociado. Los cambios en el precio final no
                                    afectarán el plan de pago existente.
                                    Para gestionar pagos, utiliza la opción "Registrar Pago" en el listado de ventas.
                                </p>
                            </div>
                        </div>
                    </div>
                    }
                </div>

                <div class="flex flex-col sm:flex-row justify-end gap-3 sm:gap-4 pt-6 border-t border-gray-200">
                    <button type="button" (click)="volverAlListado()"
                        class="flex items-center justify-center gap-2 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg shadow-md transition-all duration-200 font-semibold w-full sm:w-auto">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Cancelar
                    </button>
                    <button type="submit" [disabled]="ventaForm.invalid || enviando()"
                        class="flex items-center justify-center gap-2 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white px-8 py-3 rounded-lg shadow-md transition-all duration-200 font-semibold w-full sm:w-auto disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        {{ enviando() ? 'Actualizando...' : 'Actualizar Venta' }}
                    </button>
                </div>
            </form>
            }
        </div>
    </div>
</div>